<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Premier choix — Smart Contracts Studio</title>
  <style>
    html,body { height:100%; margin:0; }
    body {
      background: #000; /* fond noir */
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    .container {
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
      justify-content:center;
    }
    button.choice {
      background:#16a34a; /* vert */
      color:#051923;
      border:none;
      padding:14px 28px;
      font-size:18px;
      border-radius:8px;
      cursor:pointer;
      min-width:220px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }
    button.choice:active { transform: translateY(1px); }
    .message {
      margin-top:18px;
      padding:10px 14px;
      background: rgba(255,255,255,0.04);
      border-radius:6px;
      color:#cfeee3;
      min-height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      max-width:420px;
      text-align:center;
    }
    .clock {
      margin-top:12px;
      padding:12px 24px;
      background: linear-gradient(135deg, rgba(22,163,74,0.15), rgba(5,25,35,0.3));
      border-radius:8px;
      color:#16a34a;
      font-size:28px;
      font-weight:700;
      font-family: 'Courier New', monospace;
      letter-spacing:2px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="title">
    <!-- boutons avec data-action pour event delegation -->
    <button class="choice" data-action="utilisateur" type="button" aria-label="Choisir Utilisateur">Utilisateur</button>
    <button class="choice" data-action="créateur" type="button" aria-label="Choisir Créateur">Créateur</button>

    <div class="message" id="message" role="status" aria-live="polite">Faites un choix pour commencer</div>
    
    <!-- Horloge en temps réel -->
    <div class="clock" id="clock" aria-label="Horloge en temps réel">--:--:--</div>

    <!-- Carte utilisateur (affichée sous l'horloge) -->
    <div id="user-info" aria-label="Informations utilisateur" style="margin-top:12px; display:flex; align-items:center; justify-content:center; width:100%;"></div>

    <!-- Vues conditionnelles : user store et creator form -->
    <div id="user-store" style="display:none; margin-top:24px; width:100%; max-width:960px;">
      <h2 style="margin:0 0 12px 0; color:#cfeee3; text-align:center;">Marketplace — Contrats disponibles</h2>
      <div id="cards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px;"></div>
    </div>

    <div id="creator-form" style="display:none; margin-top:24px; width:100%; max-width:720px; color:#cfeee3;">
      <h2 style="margin:0 0 12px 0; color:#cfeee3; text-align:center;">Créateur — Paramétrage du contrat</h2>
      <form id="form-creator" style="display:flex; flex-direction:column; gap:10px;">
  <input name="nameUser" placeholder="Nom du contrat (ex: Billetterie)" style="padding:10px; border-radius:6px; border:1px solid #233; background:#021; color:#cfeee3;" />
        <input name="symbol" placeholder="Symbole (ex: TICKET)" style="padding:10px; border-radius:6px; border:1px solid #233; background:#021; color:#cfeee3;" />
        <textarea name="description" placeholder="Description courte" rows="3" style="padding:10px; border-radius:6px; border:1px solid #233; background:#021; color:#cfeee3;"></textarea>
        <input name="initialSupply" placeholder="Supply initial (optionnel)" style="padding:10px; border-radius:6px; border:1px solid #233; background:#021; color:#cfeee3;" />
        <select name="pricing" style="padding:10px; border-radius:6px; border:1px solid #233; background:#021; color:#cfeee3;">
          <option value="free">Gratuit</option>
          <option value="freemium">Freemium</option>
          <option value="payperuse">Paiement à l'usage</option>
          <option value="licence">Licence (NFT)</option>
        </select>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="allowInterop" /> Permettre l'interopérabilité (autres contrats)
        </label>
        <div style="display:flex; gap:8px;">
          <button type="submit" class="choice" style="flex:1;">Enregistrer & Prévisualiser</button>
          <button type="button" id="btn-reset" class="choice" style="flex:0; background:#0b8457;">Réinitialiser</button>
        </div>
      </form>
    </div>
  </div>

  <script src="essai_clean.js" defer></script>
  <script defer>
    // Code d'initialisation UI : lisible, accessible et sans polluer le scope global
    (function(){
      var container = document.querySelector('.container');
      var msgEl = document.getElementById('message');

      // Fonction d'affichage centralisée (accessible par le module JS)
      function showMessage(text){
        if (!msgEl) return;
        msgEl.textContent = String(text || '');
      }

      // Expose la fonction d'affichage via l'API App (essai_clean.js lira cette fonction)
      window.App = window.App || {};
      window.App.showMessage = showMessage;

      // Event delegation : un seul écouteur pour les boutons utilisateur/créateur
      container.addEventListener('click', function (e) {
        var btn = e.target.closest('button[data-action]');
        if (!btn) return;
        var action = btn.getAttribute('data-action');
        // utilisation de l'API publique exposée dans essai_clean.js
        if (window.App && typeof window.App.premiereChoix === 'function') {
          window.App.premiereChoix(action);
        }

        // Affichage conditionnel selon le choix
        var store = document.getElementById('user-store');
        var form = document.getElementById('creator-form');
        if (action === 'utilisateur') {
          store.style.display = '';
          form.style.display = 'none';
          renderContracts();
        } else if (action === 'créateur') {
          store.style.display = 'none';
          form.style.display = '';
        }
      });

      // Accessibilité clavier : Enter/Space
      container.addEventListener('keydown', function (e) {
        var btn = e.target.closest('button[data-action]');
        if (!btn) return;
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          btn.click();
        }
      });

      // Petite amélioration visuelle si utilisateur réduit les animations
      try{
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          document.documentElement.classList.add('reduced-motion');
        }
      }catch(e){}

      /*
       * Horloge en temps réel
       * Met à jour l'affichage toutes les secondes avec HH:MM:SS
       */
      // change la fonction si dessous "updateclock" en utilisant const à la place de var
       const updateClock = () => {
         const clockEl = document.getElementById('clock');
         if (!clockEl) return;
         const now = new Date();
         const hours = String(now.getHours()).padStart(2, '0');
         const minutes = String(now.getMinutes()).padStart(2, '0');
         const seconds = String(now.getSeconds()).padStart(2, '0');

         clockEl.textContent = hours + ':' + minutes + ':' + seconds;
      }
      
      // Lancer l'horloge immédiatement et la mettre à jour chaque seconde
      updateClock();
      setInterval(updateClock, 1000);

      // Calcule l'âge en années à partir d'une date de naissance (YYYY-MM-DD)
      const computeAge = (dobStr) => {
        const dob = new Date(dobStr);
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
        return age;
      };

      // Rendu de la carte utilisateur sous l'horloge
      const renderUser = (user) => {
        const host = document.getElementById('user-info');
        if (!host) return;
        const age = typeof user.age === 'number' ? user.age : computeAge(user.dob);
        host.innerHTML = `
          <div style="
            display:flex;
            flex-direction:column;
            gap:6px;
            padding:14px 18px;
            border-radius:10px;
            background: linear-gradient(135deg, rgba(22,163,74,0.15), rgba(5,25,35,0.35));
            color:#cfeee3;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border:1px solid #023;
            min-width:260px;
            max-width:480px;
            text-align:center;
          ">
            <div style="font-weight:700; letter-spacing:0.5px; color:#16a34a;">Utilisateur</div>
            <div><strong>Prénom</strong> : ${user.prenom}</div>
            <div><strong>Nom</strong> : ${user.nom}</div>
            <div><strong>Âge</strong> : ${age} ans</div>
          </div>
        `;
      };

      // Créer et afficher l'utilisateur demandé
      const user = {
        nom: 'Karaoui',
        prenom: 'Malik',
        // On garde la date de naissance pour un calcul d'âge toujours exact
        dob: '1989-03-11'
      };
      renderUser(user);
      
      /*
       * Marketplace rendering (minimaliste) :
       * - On charge une liste d'exemples et on rend des cartes.
       * - Au clic sur "Installer", on demande la connexion wallet (si disponible).
       */
      var contracts = [
        { id:1, title:'Billetterie NFT', desc:'Émission NFT billets + contrôle accès', rating:4.5, author:'ConcertLab' },
        { id:2, title:'Escrow Pay', desc:"Escrow on-chain pour ventes et paiements programmés", rating:4.0, author:'SafePay' },
        { id:3, title:'Subscription Billing', desc:'Paiement récurrent avec relances et refunds', rating:4.2, author:'SubTech' }
      ];

      function renderContracts(){
        var cards = document.getElementById('cards');
        if (!cards) return;
        // clear
        cards.innerHTML = '';
        contracts.forEach(function(c){
          var card = document.createElement('div');
          card.style.background = 'linear-gradient(135deg,#071,#012)';
          card.style.padding = '12px';
          card.style.borderRadius = '10px';
          card.style.color = '#cfeee3';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.gap = '8px';

          var thumb = document.createElement('div');
          thumb.style.height = '100px';
          thumb.style.borderRadius = '8px';
          thumb.style.background = 'radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), rgba(0,0,0,0.06))';
          thumb.textContent = c.title;
          thumb.style.display = 'flex';
          thumb.style.alignItems = 'center';
          thumb.style.justifyContent = 'center';
          thumb.style.fontWeight = '600';

          var title = document.createElement('div'); title.textContent = c.title; title.style.fontWeight='700';
          var desc = document.createElement('div'); desc.textContent = c.desc; desc.style.fontSize='13px'; desc.style.opacity='0.95';
          var meta = document.createElement('div'); meta.style.display='flex'; meta.style.justifyContent='space-between'; meta.style.alignItems='center';
          var author = document.createElement('div'); author.textContent = 'par ' + c.author; author.style.fontSize='12px'; author.style.opacity='0.9';
          var stars = document.createElement('div'); stars.innerHTML = renderStars(c.rating);
          meta.appendChild(author); meta.appendChild(stars);

          var btn = document.createElement('button'); btn.className='choice'; btn.textContent='Installer';
          btn.addEventListener('click', function(){
            // demande de connexion au wallet si disponible
            connectWallet().then(function(acc){
              if (acc) {
                showMessage('Wallet connecté: ' + acc[0]);
                // ici lancer le flow d'installation / déploiement
              } else {
                showMessage('Aucun wallet détecté — installez MetaMask ou utilisez une extension compatible.');
              }
            }).catch(function(err){
              showMessage('Connexion wallet annulée ou erreur');
            });
          });

          card.appendChild(thumb);
          card.appendChild(title);
          card.appendChild(desc);
          card.appendChild(meta);
          card.appendChild(btn);
          cards.appendChild(card);
        });
      }

      function renderStars(rating){
        var out='';
        var full = Math.floor(rating);
        for(var i=0;i<full;i++) out += '★';
        if(rating - full >= 0.5) out += '☆';
        return '<span style="color:#ffd54a">'+out+'</span>';
      }

      function connectWallet(){
        return new Promise(function(resolve, reject){
          if (window.ethereum && window.ethereum.request) {
            window.ethereum.request({ method: 'eth_requestAccounts' }).then(function(accounts){
              resolve(accounts);
            }).catch(function(err){ reject(err); });
          } else {
            resolve(null);
          }
        });
      }

      // Form interactions: preview & reset
      var form = document.getElementById('form-creator');
      if (form) {
        form.addEventListener('submit', function(e){
          e.preventDefault();
          var data = new FormData(form);
          var summary = 'Prévisualisation:\n' +
            'Nom: ' + (data.get('nameUser')||'<vide>') + '\n' +
            'Symbole: ' + (data.get('symbol')||'<vide>') + '\n' +
            'Desc: ' + (data.get('description')||'<vide>') + '\n' +
            'Pricing: ' + (data.get('pricing')||'<vide>') + '\n' +
            'Interop: ' + (data.get('allowInterop') ? 'Oui' : 'Non');
          // Affichage simple
          showMessage(summary);
        });
        var btnReset = document.getElementById('btn-reset');
        if (btnReset) btnReset.addEventListener('click', function(){ form.reset(); showMessage('Formulaire réinitialisé'); });
      }
    })();
  </script>
</body>
</html>
